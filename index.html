<!-- Rebuild test 2026-02-19 -->

<!doctype html>
<html lang="en" class="h-full bg-gray-50">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Calmday â€“ Speak & Transcribe</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .recording { animation: pulse 2s infinite; }
    @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.6; } }
  </style>
</head>
<body class="h-full font-sans antialiased">
  <div class="min-h-full flex flex-col items-center justify-center p-4">
    <div class="max-w-md w-full space-y-8">
      <div class="text-center">
        <h1 class="text-4xl font-bold text-gray-900">Calmday</h1>
        <p class="mt-2 text-lg text-gray-600">Speak naturally â†’ get transcription</p>
      </div>

      <!-- Status / Result -->
      <div id="status" class="text-center text-gray-700 min-h-[4rem]"></div>
      <div id="result" class="hidden bg-white p-4 rounded-lg shadow border border-gray-200">
        <p class="font-medium text-gray-800">Transcription:</p>
        <p id="transcription" class="mt-2 text-gray-900 whitespace-pre-wrap"></p>
      </div>

      <!-- Record button -->
      <div class="flex justify-center">
        <button id="recordBtn" 
                class="px-8 py-6 rounded-full bg-indigo-600 text-white text-xl font-semibold shadow-lg hover:bg-indigo-700 focus:outline-none focus:ring-4 focus:ring-indigo-300 transition">
          ðŸŽ¤ Start Recording
        </button>
      </div>

      <!-- Stop button (hidden initially) -->
      <div class="flex justify-center hidden" id="stopContainer">
        <button id="stopBtn" 
                class="px-8 py-6 rounded-full bg-red-600 text-white text-xl font-semibold shadow-lg hover:bg-red-700 focus:outline-none focus:ring-4 focus:ring-red-300 transition recording">
          â–  Stop & Transcribe
        </button>
      </div>
    </div>
  </div>

  <script>
    let mediaRecorder;
    let audioChunks = [];

    const recordBtn = document.getElementById('recordBtn');
    const stopBtn = document.getElementById('stopBtn');
    const stopContainer = document.getElementById('stopContainer');
    const status = document.getElementById('status');
    const resultDiv = document.getElementById('result');
    const transcriptionP = document.getElementById('transcription');

    recordBtn.addEventListener('click', async () => {
      try {
        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        mediaRecorder = new MediaRecorder(stream);
        audioChunks = [];

        mediaRecorder.ondataavailable = e => audioChunks.push(e.data);
        mediaRecorder.onstop = sendToBackend;

        mediaRecorder.start();
        recordBtn.classList.add('hidden');
        stopContainer.classList.remove('hidden');
        status.textContent = 'Recording... speak now';
      } catch (err) {
        status.textContent = 'Microphone access denied or not available';
        console.error(err);
      }
    });

    stopBtn.addEventListener('click', () => {
      mediaRecorder.stop();
      mediaRecorder.stream.getTracks().forEach(track => track.stop());
      recordBtn.classList.remove('hidden');
      stopContainer.classList.add('hidden');
      status.textContent = 'Processing...';
    });

    async function sendToBackend() {
      const audioBlob = new Blob(audioChunks, { type: 'audio/wav' });
      const formData = new FormData();
      formData.append('audio', audioBlob, 'recording.wav');

      try {
        const res = await fetch('https://calmday-app.stephanwesseling.workers.dev', {
          method: 'POST',
          body: audioBlob,                    // raw blob, no FormData needed
          headers: { 'Content-Type': 'audio/wav' }
        });

        if (!res.ok) throw new Error(`Server error ${res.status}`);

        const json = await res.json();
        transcriptionP.textContent = json.text || 'No transcription';
        resultDiv.classList.remove('hidden');
        status.textContent = 'Done!';
      } catch (err) {
        status.textContent = 'Error: ' + err.message;
        console.error(err);
      }
    }
  </script>
</body>
</html>
